<!DOCTYPE html>
<html lang="en">
  <head>
    <head>
      <meta charset="UTF-8">
      <title>RxPlayer - CANAL+ (stand-alone demo)</title>
    </head>
    <body>
      <video id="video" height="270px" width="480px"></video>
      <script type="text/javascript" src="./lib.js" charset="utf-8"></script>
      <script charset="utf-8">
        const player = new window.RxPlayer({
          videoElement: document.getElementById("video")
        });
        window.RxPlayer.LogLevel = "DEBUG";
        window.player = player;

        // Bytes utils
        function strToBytes(str) {
          const len = str.length;
          const arr = new Uint8Array(len);
          for (let i = 0; i < len; i += 1) {
            arr[i] = str.charCodeAt(i) & 0xFF;
          }
          return arr;
        }

        function bytesToStr(bytes) {
          return String.fromCharCode.apply(null, bytes);
        }

        function bytesToUTF16Str(bytes) {
          let str = "";
          const len = bytes.length;
          for (let i = 0; i < len; i += 2) {
            str += String.fromCharCode(bytes[i]);
          }
          return str;
        }

        // Key system infos

        const url = "https://demo.unified-streaming.com/video/tears-of-steel/tears-of-steel-dash-playready.ism/.mpd";
        const licenseServerUrl = "https://test.playready.microsoft.com/service/rightsmanager.asmx?PlayRight=1&UseSimpleNonPersistentLicense=1";
        const keySystem = "com.microsoft.playready";
        // const mediaKeySystemAccessConfig = [{ 
        //   initDataTypes: ["cenc"],
        //   audioCapabilities:[{
        //     robustness: "",
        //     contentType: "audio/mp4; codecs=\"mp4a.40.2\"",
        //   }],
        //   videoCapabilities:[{
        //     robustness: "",
        //     contentType: "video/mp4;codecs=\"avc1.640028\"",
        //   }],
        //   distinctiveIdentifier: "required",
        //   persistentState: "required",
        //   sessionTypes: ["temporary"],
        //   label:"com.microsoft.playready",
        // }];

        function formatPlayreadyChallenge(challenge) {
          const str = bytesToUTF16Str(challenge);
          const match = /<Challenge encoding="base64encoded">(.*)<\/Challenge>/.exec(str);
          const xml = match ?
            atob(match[1]) : /* IE11 / EDGE */
            bytesToStr(new Uint8Array(challenge)); // Chromecast
          return xml;
        }

        const generateGetLicense = (isPlayready) => (rawChallenge) => {
          const challenge = isPlayready ? formatPlayreadyChallenge(rawChallenge) :  
                                          new Uint8Array(rawChallenge);
          const xhr = new XMLHttpRequest();
          xhr.open("POST", licenseServerUrl, true);
          return new Promise((resolve, reject) => {
            xhr.onerror = () => {
              const error = new Error("getLicense's request failed on an error");
              error.fallbackOnLastTry = fallbackOnLastTry;
              reject(error);
            };
            xhr.onload = (evt) => {
              if (xhr.status >= 200 && xhr.status < 300) {
                const license = evt.target.response;
                resolve(license);
              } else {
                const error = new Error("getLicense's request finished with a " +
                                        `${xhr.status} HTTP error`);
                error.noRetry = fallbackOnLastTry;
                error.fallbackOnLastTry = fallbackOnLastTry;
                reject(error);
              }
            };
            if (isPlayready) {
              xhr.setRequestHeader("content-type", "text/xml; charset=utf-8");
            } else {
              xhr.responseType = "arraybuffer";
            }
            xhr.send(challenge);
          }).then(license =>
            typeof isPlayready && license === "string" ? strToBytes(license) : license
          );
        };

        // Load and play
        player.loadVideo({
          url,
          transport: "dash",
          autoPlay: true,
          keySystems: [{ type: keySystem,
                         persistentStateRequired: true,
                         distinctiveIdentifierRequired: true,
                         getLicense:
                           generateGetLicense("com.microsoft.playready" === keySystem), }],
        });
      </script>
    </body>

</html>
