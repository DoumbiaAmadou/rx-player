<!DOCTYPE html>
<html lang="en">
  <head>
    <head>
      <meta charset="UTF-8">
      <title>RxPlayer - CANAL+ (stand-alone demo)</title>
    </head>
    <body>
      <video id="video" height="270px" width="480px"></video>
      <script type="text/javascript" src="./lib.js" charset="utf-8"></script>
      <script charset="utf-8">
        const url = "https://dsh-m005-live-aka-canalplus.akamaized.net/live/disk/rfmtv-hd/dash-fhd/rfmtv-hd.mpd";
        const licenseServerUrl = "https://secure-webtv.canal-bis.com/WebPortal-vabf/TestDRMDASH/api/Playready";

        // You can set it to "INFO" or even to "NONE" if too verbose
        window.RxPlayer.LogLevel = "DEBUG";

        const player = new window.RxPlayer({
          videoElement: document.getElementById("video")
        });
        window.player = player;

        /**
         * Convert an array of UTF-16 code points to its JS string form.
         * @param {Uint8Array} bytes
         * @returns {string}
         */
        function UTF16BytesToString(bytes) {
          return String.fromCharCode.apply(null, bytes);
        }

        /**
         * Update the format of the "challenge" before sending it to the license
         * server.
         * @param {Uint8Array} challenge
         * @returns {string}
         */
        function formatPlayreadyChallenge(challenge) {
          const str = UTF16BytesToString(challenge);

          // The challenge can be wrapped as Base64 in an XML node in some platforms.
          // Extract it if we're in that case.
          const match = /<Challenge encoding="base64encoded">(.*)<\/Challenge>/.exec(str);
          const xml = match ?
            atob(match[1]) : /* IE11 / EDGE */
            str;
          return xml;
        }

        /**
         * Function called by the RxPlayer when a CDM send us a message for a
         * license request.
         * This function formats the "challenge", send the requests, formats the
         * license and give it in a BufferSource form to the RxPlayer which will
         * just pass it through to the CDM (through the MediaKeySession.update
         * method).
         * @param {Uint8Array} challenge
         * @returns {Promise.<Uint8Array|ArrayBuffer>}
         */
        function getLicense(rawChallenge) {
          const challenge = formatPlayreadyChallenge(rawChallenge);
          const xhr = new XMLHttpRequest();
          xhr.open("POST", licenseServerUrl, true);
          return new Promise((resolve, reject) => {
            xhr.onerror = (err) => {
              const error = new Error("getLicense's request failed on an error: " + err);
              reject(error);
            };
            xhr.onload = (evt) => {
              if (xhr.status >= 200 && xhr.status < 300) {
                const license = evt.target.response;
                resolve(license);
              } else {
                const error = new Error("getLicense's request finished with a " +
                                        `${xhr.status} HTTP error`);
                reject(error);
              }
            };
            xhr.responseType = "arraybuffer";
            xhr.setRequestHeader("content-type", "text/xml; charset=utf-8");
            xhr.send(challenge);
          });
        };

        // Load and play
        function load() {
          player.loadVideo({ url,
                             transport: "dash",
                             autoPlay: true,
                             keySystems: [{ type: "com.microsoft.playready",
                                            persistentStateRequired: true,
                                            distinctiveIdentifierRequired: true,
                                            getLicense } ] });
        }
        window.reloadVideo = load;
        load();
      </script>
    </body>

</html>
