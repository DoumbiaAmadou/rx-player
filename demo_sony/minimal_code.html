<!DOCTYPE html>
<html lang="en">
  <head>
    <head>
      <meta charset="UTF-8">
      <title>RxPlayer - CANAL+ (stand-alone demo)</title>
    </head>
    <body>
      <script charset="utf-8">
let videoElement;
let mediaSource;

const keySystem = "com.microsoft.playready";
const mediaKeySystemAccessConfig = [{
  initDataTypes: ["cenc"],
  audioCapabilities:[{
    robustness: "",
    contentType: "audio/mp4; codecs=\"mp4a.40.2\"",
  }],
  videoCapabilities:[{
    robustness: "",
    contentType: "video/mp4;codecs=\"avc1.640028\"",
  }],
  distinctiveIdentifier: "required",
  persistentState: "required",
  sessionTypes: ["temporary"],
  label:"com.microsoft.playready",
}];

createVideoElement();
createMediaSource()
  .then(() => {
    console.log("MediaSource.readyState:", mediaSource.readyState);
    return createMediaKeySystemAccess();
  })
  .then((mediaKeySystemAccess) => {
    console.log("MediaSource.readyState:", mediaSource.readyState);
    return createMediaKeys(mediaKeySystemAccess);
  })
  .then((mediaKeys) => {
    console.log("MediaSource.readyState:", mediaSource.readyState);
    return attachMediaKeysToVideoElement(mediaKeys);
  }).then(() => {
    console.log("MediaSource.readyState:", mediaSource.readyState);

    console.log("Trying to set a duration on the MediaSource.")
    try {
      mediaSource.duration = 10;
      console.log("Duration set with success!")
    } catch (e) {
      console.error("Could not set the duration:", e);

      const div = document.createElement("div");
      div.style.color = "red";
      div.innerText = "Error when setting the duration: " + e.toString();
      document.body.appendChild(div);
    }
  });

function createVideoElement() {
  console.log("Creating video element...")
  videoElement = document.createElement("video");
  document.body.appendChild(videoElement);
  console.log("Video element created.");
}

function createMediaSource() {
  return new Promise(res => {
    console.log("Opening MediaSource...")
    mediaSource = new MediaSource();
    const mediaSourceURL = URL.createObjectURL(mediaSource);
    videoElement.src = mediaSourceURL;
    mediaSource.addEventListener("sourceopen", () => {
      console.log("MediaSource opened.");
      res();
    });
  });
}

function createMediaKeySystemAccess() {
  console.log("Creating MediaKeySystemAccess");
  return navigator.requestMediaKeySystemAccess(
    keySystem,
    mediaKeySystemAccessConfig
  ).then(
    (mediaKeySystemAccess) => {
      console.log("MediaKeySystemAccess created.");
      return mediaKeySystemAccess;
    },
    (err) => {
      console.error("Failed to create MediaKeySystemAccess", err);
      throw err;
    },
  );
}
function createMediaKeys(mediaKeySystemAccess) {
  console.log("Creating MediaKeys.");
  return mediaKeySystemAccess.createMediaKeys().then(
    (mediaKeys) => {
      console.log("MediaKeys created.");
      return mediaKeys;
    },
    (err) => {
      console.error("Failed to create MediaKeys", err);
      throw err;
    },
  );
}
function attachMediaKeysToVideoElement(mediaKeys) {
  console.log("Attaching MediaKeys...");
  return videoElement.setMediaKeys(mediaKeys).then(
    () => {
      console.log("MediaKeys attached.");
    },
    (err) => {
      console.error("Failed to create MediaKeys", err);
      throw err;
    },
  );
}
      </script>
    </body>

</html>