<!DOCTYPE html>
<html lang="en">
  <head>
    <head>
      <meta charset="UTF-8">
      <title>RxPlayer - CANAL+ (stand-alone demo)</title>
    </head>
    <body>
      <video id="video" width="1920px" height="1080px"></video>
      <script type="text/javascript" src="./lib.js" charset="utf-8"></script>
      <script charset="utf-8">
        const player = new window.RxPlayer({
          videoElement: document.getElementById("video"),
          maxBufferAhead: 15,
          maxBufferBehind: 5,
        });

        function bytesToUTF16Str(bytes) {
          let str = "";
          const len = bytes.length;
          for (let i = 0; i < len; i += 2) {
            str += String.fromCharCode(bytes[i]);
          }
          return str;
        }

        function bytesToStr(bytes) {
          return String.fromCharCode.apply(null, bytes);
        }

        function strToBytes(str) {
          const len = str.length;
          const arr = new Uint8Array(len);
          for (let i = 0; i < len; i += 1) {
            arr[i] = str.charCodeAt(i) & 0xFF;
          }
          return arr;
        }

        function formatPlayreadyChallenge(challenge) {
          const str = bytesToUTF16Str(challenge);
          const match = /<Challenge encoding="base64encoded">(.*)<\/Challenge>/.exec(str);
          const xml = match ?
            atob(match[1]) : /* IE11 / EDGE */
            bytesToStr(new Uint8Array(challenge)); // Chromecast
          return xml;
        }

        player.loadVideo({
          // url: "https://akamaibroadcasteruseast.akamaized.net/cmaf/live/657078/akasource/out.mpd",
          // url : "https://live.unified-streaming.com/scte35/scte35.isml/.mpd",
          // url: "https://dsh-m005-live-aka-canalplus.akamaized.net/live/disk/tvbreizh-hd/dash-fhddvr/tvbreizh-hd.mpd",
          url: "https://dsh-m006.p-cdnlive-edge010408.scy.canalplus-cdn.net/telia-9b3bb9539353aa11e3396f932877d105-c611/live/disk/alaune-clair-hd/dash-fhd-clair/alaune-clair-hd.mpd",
          autoPlay: true,
          transport: "dash",
          // keySystems: [
          //   {
          //     type: "playready",
          //     getLicense: (rawChallenge) => {
          //        const challenge =  formatPlayreadyChallenge(rawChallenge);
          //        const xhr = new XMLHttpRequest();
          //        xhr.open("POST", "https://cors-anywhere.herokuapp.com/https://secure-webtv.canal-bis.com/WebPortal-vabf/TestDRMDASH/api/Playready", true);
          //        return new Promise((resolve, reject) => {
          //          xhr.onerror = () => {
          //            const error = new Error("getLicense's request failed on an error");
          //            error.fallbackOnLastTry = true;
          //            reject(error);
          //          };
          //          xhr.onload = (evt) => {
          //            if (xhr.status >= 200 && xhr.status < 300) {
          //              const license = evt.target.response;
          //              resolve(license);
          //            } else {
          //              const error = new Error("getLicense's request finished with a " +
          //                                      `${xhr.status} HTTP error`);
          //              error.noRetry = true;
          //              error.fallbackOnLastTry = true;
          //              reject(error);
          //            }
          //          };
          //          xhr.setRequestHeader("content-type", "text/xml; charset=utf-8");
          //          xhr.send(challenge);
          //        }).then(license =>
          //          typeof license === "string" ? strToBytes(license) : license
          //        );
          //     }
          //   }
          // ]
        });

        window.player = player;
      </script>
    </body>

</html>
